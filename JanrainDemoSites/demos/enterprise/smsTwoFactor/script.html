<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script type="text/javascript">
    // --- page-specific settings ------------------------------------------
    janrain.settings.capture.flowName = 'SMSAuth_TwoFactor';
    janrain.settings.capture.stylesheets = ['styles/janrain.css'];
    //janrain.settings.capture.mobileFlowName = 'mobile';
    janrain.settings.capture.mobileStylesheets = ['styles/janrain-mobile.css'];

    smsVerified = false;
    smsSendFormData = "";
    // --- define event handlers and start the janrain ui ------------------
    function janrainCaptureWidgetOnLoad() {

        var utilFuncs = janrainUtilityFunctions();

        janrain.events.onCaptureSessionCreated.addHandler(function(result) {
            janrain.capture.ui.modal.close();
            if (window.console && window.console.log) console.log(result) ;
            document.getElementById("captureSignInLink").style.display = 'none';
            document.getElementById("captureSignOutLink").style.display = '';
            document.getElementById("captureProfileLink").style.display = '';
        });

        janrain.events.onCaptureSessionFound.addHandler(function(result) {
            janrain.capture.ui.modal.close();
            if (window.console && window.console.log) console.log(result);
            document.getElementById("captureSignInLink").style.display = 'none';
            document.getElementById("captureSignOutLink").style.display = '';
            document.getElementById("captureProfileLink").style.display = '';
        });

        janrain.events.onCaptureRegistrationSuccess.addHandler(function(result) {
            janrain.capture.ui.modal.close();
            if (window.console && window.console.log) console.log(result);
            document.getElementById("captureSignInLink").style.display = 'none';
            document.getElementById("captureSignOutLink").style.display = '';
            document.getElementById("captureProfileLink").style.display = '';
        });

        janrain.events.onCaptureSessionEnded.addHandler(function(result) {
            document.getElementById("captureSignInLink").style.display = '';
            document.getElementById("captureSignOutLink").style.display = 'none';
            document.getElementById("captureProfileLink").style.display = 'none';
            document.getElementById('editProfile').style.visibility='hidden';
        });

        janrain.events.onCaptureScreenShow.addHandler(function(result) {
            if (result.screen == "returnTraditional") {
                janrainReturnExperience();
            }
        });

        janrain.events.onCaptureSaveSuccess.addHandler(function(result) {
            if (result.screen == "smsVerify" && result.statusMessage == "verified") {
                smsVerified = true;
            }
        });

        janrain.events.onCaptureProfileSaveSuccess.addHandler(function(result) {
            if (result.screen == "smsSend" &&
                result.form == "smsUpdatePhoneForm" &&
                result.status == "success") {
                $('.capture_processing').hide();
                $('#capture_smsSend_saveButton').show();
                $('#sms_update_number_status').text('Phone number updated').show();
            }
        });

         janrain.events.onCaptureRenderComplete.addHandler(function(result) {
            if (result.screen == "smsSuccess" && smsVerified ){
                janrain.capture.ui.postCaptureForm('smsSuccessForm');
            }

            if (result.screen == "traditionalRegistration" ){
                $("#capture_traditionalRegistration_registrationForm").submit(function(e){
                    //e.preventDefault();
                    smsSendFormData = '&login_id=';
                    smsSendFormData += encodeURIComponent($('#capture_traditionalRegistration_traditionalRegistration_emailAddress').val());
                    smsSendFormData += '&login_password=';
                    smsSendFormData += encodeURIComponent($('#capture_traditionalRegistration_traditionalRegistration_password').val());
                    //var form = this;
                    //form.submit(); // submit bypassing the jQuery bound event
                    return true;
                });
            }

            if (result.screen =='smsSend' && smsVerified) {
                janrain.capture.ui.modal.close();
            }

        });

        janrain.events.onCapturePostLoginScreen.addHandler(function(result){
            if (result.screen=='smsSuccess' && result.accessToken) {
                janrain.capture.ui.modal.close();
                if (window.console && window.console.log) console.log(result) ;
                document.getElementById("captureSignInLink").style.display = 'none';
                document.getElementById("captureSignOutLink").style.display = '';
                document.getElementById("captureProfileLink").style.display = '';
            }

        });


        //Detailed All Event Logging
        function addEventHandler(e) {
            janrain.events[e].addHandler(function(result) {
                console.log(e, result);
            });
        }
        if (window.console && window.console.log) {
            for (var janrainEvent in janrain.events) {
                try {
                    var eventName = janrainEvent;

                    if(janrainEvent.hasOwnProperty('eventName')) {
                        eventName = janrainEvent.eventName;
                    }
                    addEventHandler(eventName);
                } catch(err) {
                    // No op.
                    // If we got here, the object it was working with was not an
                    // event and can safely be ignored.
                    //console.log(err);
                }
            }
        }
        ///////////////////////


        // should be the last line in janrainCaptureWidgetOnLoad()
        janrain.capture.ui.start();
    }

    function sendSmsCode(obj, mode){
        $('.sms_error').hide();
        $(obj).hide();
        $('<div class="capture_btn capture_processing"></div>').insertBefore(obj);
        var formdata = 'app_id=' + encodeURIComponent(janrain.settings.capture.appId);
        formdata += '&client_id=' + encodeURIComponent(janrain.settings.capture.clientId);
        if (mode == "login") {
            if($('#login_id').is(':visible')) {
                formdata += '&login_id=' + encodeURIComponent($('#login_id').val());
                formdata += '&login_password=' + encodeURIComponent($('#login_password').val());
            }
            if($('#return_id').is(':visible')) {
                formdata += '&login_id=' + encodeURIComponent($('#return_id').val());
                formdata += '&login_password=' + encodeURIComponent($('#return_password').val());
            }
        }
        if (mode == "reg") formdata += smsSendFormData;
        sendResult = $.ajax( {
            type: "POST",
            dataType: "json",
            url: "https://9z5v3eb9r8.execute-api.us-east-1.amazonaws.com/2fauth_dev/sendsmscode?" + formdata,
            contentType: "application/x-www-form-urlencoded",
            success: function(result, textStatus, jqXHR) {
                if (result["stat"] == "ok") {
                    if (mode=="login"){
                        $('.sms_login_form').hide();
                        $('.sms_verify_form').show();
                    } else {
                        janrain.capture.ui.modal.open('smsVerify')
                    }
                } else {
                    alert("Unexpected Error: " + result);
                    console.log(result);
                }
                //Important: remember to clear this value.
                smsSendFormData = "";
            },
            error: function( jqXHR, textStatus, errorThrown) {
                $('.sms_error').text(jqXHR.responseJSON.message).show();
                console.log("Unexpected Error: ", jqXHR.responseJSON);
            },
            complete: function(){
                $(obj).show();
                $('.capture_processing').hide();
            }
        });
    }


    function verifySmsCode(obj){
        $('.sms_error').hide();
        $(obj).hide();
        $('<div class="capture_btn capture_processing"></div>').insertBefore(obj);
        var formdata = 'app_id=' + encodeURIComponent(janrain.settings.capture.appId);
        formdata += '&client_id=' + encodeURIComponent(janrain.settings.capture.clientId);
        if($('#login_id').val() != '') formdata += '&login_id=' + encodeURIComponent($('#login_id').val());
        if($('#return_id').val() != '') formdata += '&login_id=' + encodeURIComponent($('#return_id').val());
        if($('#verify_code').val() != '')formdata += '&verify_code=' + encodeURIComponent($('#verify_code').val());
        if($('#return_code').val() != '')formdata += '&verify_code=' + encodeURIComponent($('#return_code').val());
        $.ajax( {
            type: "POST",
            dataType: "json",
            jsonp: false,
            url: "https://9z5v3eb9r8.execute-api.us-east-1.amazonaws.com/2fauth_dev/verifysmscode?" + formdata,
            contentType: "application/x-www-form-urlencoded",
            success: function(data, textStatus, jqXHR) {
                if(data["access_token"] && data["access_token"] != ""){
                    janrain.capture.ui.createCaptureSession(data["access_token"]);
                }else{
                    alert("Unexpected Error: " + result);
                    console.log("Unexpected Error: ", result);
                }
                //Important: remember to clear this value.
                smsSendFormData = "";
            },
            error: function( jqXHR, textStatus, errorThrown) {
                //alert(jqXHR.responseJSON.message)
                err = jqXHR.responseJSON.message
                // The api returns a could not find user record error
                // most likely this is because the sms code entered is invalid
                if (err == "Could not retrieve user record") err = "Invalid code entered"
                $('.sms_error').text(err).show();
                console.log(jqXHR.responseJSON);
            },
            complete: function(){
                $(obj).show();
                $('.capture_processing').hide();
            }
        });
    }

</script>
